trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  PYTHON_VERSION: '3.11'
  APP_NAME: 'eg-erp-app'
  PACKAGE_PATH: '$(System.DefaultWorkingDirectory)/app.zip'

steps:
  # 🐍 Set up Python
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '$(PYTHON_VERSION)'
    displayName: 'Set Python Version'

  # 📦 Install project dependencies
  - script: |
      python -m pip install --upgrade pip
      pip install -r requirements.txt
    displayName: 'Install Django Dependencies'

  # ⚙️ Django setup: migrations + static files
  - script: |
      python manage.py migrate --noinput
      python manage.py collectstatic --noinput
    displayName: 'Run Migrations & Collect Static Files'

  # 🗜️ Package app for deployment
  - script: |
      zip -r app.zip . -x "*.git*" "*.venv*" "tests/*"
    displayName: 'Package Django App'

  # 🚀 Deploy to Azure Web App using federated identity
  - task: AzureWebApp@1
    inputs:
      azureSubscription: 'EG-Service Connection'  # ✅ Friendly name of your service connection
      appType: 'webAppLinux'
      appName: '$(APP_NAME)'
      package: '$(PACKAGE_PATH)'
    displayName: 'Deploy to Azure Web App'



