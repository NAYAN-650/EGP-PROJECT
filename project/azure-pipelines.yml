trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  PYTHON_VERSION: '3.11'
  APP_NAME: 'eg-erp-app'
  PACKAGE_PATH: '$(System.DefaultWorkingDirectory)/app.zip'

steps:
  # ğŸ Set up Python
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '$(PYTHON_VERSION)'
    displayName: 'Set Python Version'

  # ğŸ“¦ Install project dependencies
  - script: |
      python -m pip install --upgrade pip
      pip install -r requirements.txt
    displayName: 'Install Django Dependencies'

  # âš™ï¸ Django setup: migrations + static files
  - script: |
      python manage.py migrate --noinput
      python manage.py collectstatic --noinput
    displayName: 'Run Migrations & Collect Static Files'

  # ğŸ—œï¸ Package app for deployment
  - script: |
      zip -r app.zip . -x "*.git*" "*.venv*" "tests/*"
    displayName: 'Package Django App'

  # ğŸš€ Deploy to Azure Web App using federated identity
  - task: AzureWebApp@1
    inputs:
      azureSubscription: 'EG-Service Connection'  # âœ… Friendly name of your service connection
      appType: 'webAppLinux'
      appName: '$(APP_NAME)'
      package: '$(PACKAGE_PATH)'
    displayName: 'Deploy to Azure Web App'



